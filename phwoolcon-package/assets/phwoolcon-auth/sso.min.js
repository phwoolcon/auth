/*! phwoolcon sso.min.js v1.0-dev https://github.com/phwoolcon/auth | Apache-2.0 */
!function(e,t){function n(e){r("Client login"),r(e),y.notifyField.value=e,y.submit(),r("App notification sent")}function i(){C.clientUid&&r("Client logout"),O.setUid(null),y.notifyField.value="",y.submit(),r("App notification sent")}function o(e){var t=s(e.data);r("Handle in client"),t.login&&n(t.login),t.setUid&&O.setUid(t.setUid),t.logout&&i()}function r(t){e.console&&k.debug&&(e.console.trace?e.console.trace(t):e.console.log(t))}function s(t){var n;try{return n=e.JSON.parse(t)}catch(i){return t}}function c(t){return e.JSON.stringify(t)}function a(e,t,n){"addEventListener"in e?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)}function l(e,t){e.postMessage("string"==typeof t?t:c(t),v)}function u(){var t=C.clientUid,n=O.getUid();m=e.parent,S=setTimeout(function(){u.apply(O)},1e3),t!=n&&(r("Server uid: "+n),n?(r("Login: "+n),fetch(k.ssoServer+k.ssoServerCheckUri,{method:"POST",body:$p.jsonToFormData({notifyUrl:k.notifyUrl,initTime:k.initTime,initToken:k.initToken})}).then(function(e){if(e.status>=200&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,t}).then(function(e){return e.json()}).then(function(e){C.clientUid=n,r(e),l(m,{login:e.user_data})})["catch"](function(e){r("Request failed:"),r(e)}),l(m,{setUid:n})):(t&&r("Logout"),C.clientUid=null,l(m,{logout:!0})))}function d(e){var t,n,i=s(e.data);(n=i.setOptions)&&O.setOptions(n),r("Handle in iframe"),(t=i.clientUid)&&(r("Aware client uid: "+t),C.clientUid=t),i.check&&u.apply(O),i.stopCheck&&(r("Stop checking"),clearTimeout(S))}e.$p||(e.$p={options:{ssoCheckUri:"sso/check",ssoServerCheckUri:"sso/server-check",baseUrl:"/"}});var p,f,h,g,m,U,y,v,S,k={ssoServer:$p.options.baseUrl,ssoCheckUri:$p.options.ssoCheckUri,ssoServerCheckUri:$p.options.ssoServerCheckUri,initToken:"",initTime:0,notifyUrl:"",debug:!1},T="_sso_client_iframe_"+ +new Date,C={},w=e.simpleStorage||{get:function(t){return e.localStorage?s(e.localStorage.getItem("_sso_"+t)):!1},set:function(t,n){return e.localStorage?e.localStorage.setItem("_sso_"+t,c(n)):!1}},O=e.$p.sso={options:k,init:function(n){if(O.setOptions(n),!p)if(p=!0,f=t.getElementsByTagName("body")[0],$p.options.isSsoServer)v=t.referrer,a(e,"message",function(e){d.apply(O,[e])});else{v=k.ssoServer,a(e,"message",function(e){o.apply(O,[e])}),h=t.createElement("iframe"),h.width=h.height=h.frameBorder=0,h.style.display="none",h.name=T,h.src="",f.appendChild(h);var i=t.createElement("input");i.type="hidden",i.name="sso_user_data",y=t.createElement("form"),y.action=k.notifyUrl,y.style.display="none",y.method="POST",y.target=T,y.appendChild(i),y.notifyField=i,f.appendChild(y)}},setOptions:function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&(k[t]=e[t]);return O},check:function(){if(!p)throw new Error("Please invoke $p.sso.init() first.");r("Start checking");var e=O.getUid(),n={clientUid:e,check:!0,setOptions:{debug:k.debug,initToken:k.initToken,initTime:k.initTime,notifyUrl:k.notifyUrl}};return g?U&&l(U,n):(g=t.createElement("iframe"),g.src=k.ssoServer+k.ssoCheckUri,g.width=g.height=g.frameBorder=0,g.style.display="none",a(g,"load",function(){U=g.contentWindow,l(U,n)}),void f.appendChild(g))},stopCheck:function(){l(U,{stopCheck:!0})},getUid:function(){return w&&w.get("uid")},setUid:function(e,t){r("Set uid: "+e),w&&w.set("uid",e,{TTL:t||0})}};if(!e.JSON)throw new Error("Please include JSON support script to your page.");a(e,"load",function(){O.init()})}(window,document);