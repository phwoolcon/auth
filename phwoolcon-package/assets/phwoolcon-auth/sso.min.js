!function(s,i){s.$p||(s.$p={options:{ssoCheckUri:"sso/check",ssoServerCheckUri:"sso/server-check",ssoServerGetUid:"sso/uid",baseUrl:"/"}});var r,c,a,n,o,d,u,t,l,f,p,h,g,U={},m=s.console,v=s.JSON,S=s.fetch,y=s.localStorage,k=$p.options.isSsoServer?"[Server]":"[Client]",T="_sso_client_iframe_"+ +new Date;function C(e){m&&(m.debug?m.debug(k,e):m.log(k,e))}function w(t){try{return v.parse(t)}catch(e){return t}}function b(e){return v.stringify(e)}function O(e,t,i){"addEventListener"in e?e.addEventListener(t,i,!1):e.attachEvent("on"+t,i)}function $(e,t){e.postMessage("string"==typeof t?t:b(t),h)}if(a={ssoServer:$p.options.baseUrl,ssoCheckUri:$p.options.ssoCheckUri,ssoServerCheckUri:$p.options.ssoServerCheckUri,ssoServerGetUid:$p.options.ssoServerGetUid,initToken:"",initTime:0,notifyUrl:"",debug:!1},n=s.simpleStorage||{get:function(e){return w(y.getItem("_sso_"+e))},set:function(e,t){return y.setItem("_sso_"+e,b(t))}},c=s.$p.sso={options:a,init:function(e){if(c.setOptions(e),!o)if(o=!0,d=i.getElementsByTagName("body")[0],$p.options.isSsoServer)h=i.referrer,O(s,"message",function(e){(function(e){var t=w(e.data),i=t.clientUid,n=t.setOptions;n&&c.setOptions(n);C("Handle in iframe"),i&&(C("Aware client uid: "+i),U.clientUid=i);t.check&&!function t(){var e=U.clientUid,i=c.getUid();function n(e){if(200<=e.status&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,t}function o(e){return e.json()}l=s.parent;if(i===r)return C("Clarifying uid..."),void S(a.ssoServer+a.ssoServerGetUid,{credentials:"same-origin"}).then(n).then(o).then(function(e){C(e),c.setUid(e.uid,1e3*e.uidTtl),t()}).catch(function(e){C("Request failed:"),C(e),g=setTimeout(function(){t()},6e4)});g=setTimeout(function(){t()},1e3);if(e===i)return;C("Server uid: "+i);i?(C("Login: "+i),S(a.ssoServer+a.ssoServerCheckUri,{method:"POST",credentials:"same-origin",body:$p.jsonToFormData({notifyUrl:a.notifyUrl,initTime:a.initTime,initToken:a.initToken})}).then(n).then(o).then(function(e){U.clientUid=i,C(e),$(l,{login:e.user_data})}).catch(function(e){C("Request failed:"),C(e)}),$(l,{setUid:i})):(e&&C("Logout"),U.clientUid=null,$(l,{logout:!0}))}();t.stopCheck&&(C("Stop checking"),clearTimeout(g))}).apply(c,[e])});else{h=a.ssoServer,O(s,"message",function(e){(function(e){var t=w(e.data);C("Handle in client"),t.login&&function(e){C("Client login"),C(e),p.notifyField.value=e,p.submit(),C("App notification sent")}(t.login);t.setUid&&c.setUid(t.setUid);t.logout&&(U.clientUid&&C("Client logout"),c.setUid(null),p.notifyField.value="",p.submit(),C("App notification sent"))}).apply(c,[e])}),(u=i.createElement("iframe")).width=u.height=u.frameBorder=0,u.style.display="none",u.name=T,u.src="",d.appendChild(u);var t=i.createElement("input");t.type="hidden",t.name="sso_user_data",(p=i.createElement("form")).action=a.notifyUrl,p.style.display="none",p.method="POST",p.target=T,p.appendChild(t),p.notifyField=t,d.appendChild(p),c.check()}},setOptions:function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&(a[t]=e[t]);return c},check:function(){C("Start checking");var e={clientUid:c.getUid(),check:!0,setOptions:{debug:a.debug,initToken:a.initToken,initTime:a.initTime,notifyUrl:a.notifyUrl}};if(t)return f&&$(f,e);(t=i.createElement("iframe")).src=a.ssoServer+a.ssoCheckUri,t.width=t.height=t.frameBorder=0,t.style.display="none",O(t,"load",function(){$(f=t.contentWindow,e)}),d.appendChild(t)},stopCheck:function(){$(f,{stopCheck:!0})},getUid:function(){return n.get("uid")},setUid:function(e,t){C("Set uid: "+e),n.set("uid",e,{TTL:t||0})}},!v||!S||!y)throw new Error("Please include `JSON`, `fetch` and `localStorage` polyfill scripts to your page.");O(s,"load",function(){c.init(s.$ssoOptions)})}(window,document);