!function(r,i){r.$p||(r.$p={options:{ssoCheckUri:"sso/check",ssoServerCheckUri:"sso/server-check",ssoServerGetUid:"sso/uid",baseUrl:"/"}});var s,c,a,n,o,d,l,t,u,f,p,h,g,U={},m=r.console,v=r.JSON,S=r.fetch,y=r.localStorage,k=$p.options.isSsoServer?"[Server]":"[Client]",T="_sso_client_iframe_"+ +new Date;function C(e){a.debug&&m&&(m.debug?m.debug(k,e):m.log(k,e))}function b(e){m&&(m.error?m.error(k,e):m.log(k,e))}function w(t){try{return v.parse(t)}catch(e){return t}}function O(e){return v.stringify(e)}function $(e,t,i){"addEventListener"in e?e.addEventListener(t,i,!1):e.attachEvent("on"+t,i)}function _(e,t){e.postMessage("string"==typeof t?t:O(t),h)}function E(){var e=U.clientUid,i=c.getUid();function t(e){if(200<=e.status&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,t}function n(e){return e.json()}function o(e){g=setTimeout(E,e)}if(u=r.parent,i===s)return C("Clarifying uid..."),void S(a.ssoServer+a.ssoServerGetUid,{credentials:"same-origin"}).then(t).then(n).then(function(e){C(e),c.setUid(e.uid,1e3*e.uidTtl),E()}).catch(function(e){C("Request failed:"),b(e),o(6e4)});o(1e3),e!==i&&(C("Server uid: "+i),i?(L(),C("Login: "+i),S(a.ssoServer+a.ssoServerCheckUri,{method:"POST",credentials:"same-origin",body:$p.jsonToFormData({notifyUrl:a.notifyUrl,initTime:a.initTime,initToken:a.initToken})}).then(t).then(n).then(function(e){var t=e.user_data;C(e),t?_(u,{login:t}):(c.setUid(i=null),_(u,{logout:!0})),U.clientUid=i,o(1e3)}).catch(function(e){C("Request failed:"),b(e),o(6e4)}),_(u,{setUid:i})):(e&&C("Logout"),U.clientUid=null,_(u,{logout:!0})))}function L(){clearTimeout(g)}if(a={ssoServer:$p.options.baseUrl,ssoCheckUri:$p.options.ssoCheckUri,ssoServerCheckUri:$p.options.ssoServerCheckUri,ssoServerGetUid:$p.options.ssoServerGetUid,initToken:"",initTime:0,notifyUrl:"",debug:!1},n=r.simpleStorage||{get:function(e){return w(y.getItem("_sso_"+e))},set:function(e,t){return y.setItem("_sso_"+e,O(t))}},c=r.$p.sso={options:a,init:function(e){if(c.setOptions(e),!o)if(o=!0,d=i.getElementsByTagName("body")[0],$p.options.isSsoServer)h=i.referrer,$(r,"message",function(e){(function(e){var t=w(e.data),i=t.clientUid,n=t.setOptions;n&&c.setOptions(n);C("Handle in iframe"),i&&(C("Aware client uid: "+i),U.clientUid=i);t.check&&E();t.stopCheck&&(C("Stop checking"),L())}).apply(c,[e])});else{h=a.ssoServer,$(r,"message",function(e){(function(e){var t=w(e.data);C("Handle in client"),t.login&&function(e){C("Client login"),C(e),p.notifyField.value=e,p.submit(),C("App notification sent")}(t.login);t.setUid&&c.setUid(t.setUid);t.logout&&(U.clientUid&&C("Client logout"),c.setUid(null),p.notifyField.value="",p.submit(),C("App notification sent"))}).apply(c,[e])}),(l=i.createElement("iframe")).width=l.height=l.frameBorder=0,l.style.display="none",l.name=T,l.src="",d.appendChild(l);var t=i.createElement("input");t.type="hidden",t.name="sso_user_data",(p=i.createElement("form")).action=a.notifyUrl,p.style.display="none",p.method="POST",p.target=T,p.appendChild(t),p.notifyField=t,d.appendChild(p),c.check()}},setOptions:function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&(a[t]=e[t]);return c},check:function(){C("Start checking");var e={clientUid:c.getUid(),check:!0,setOptions:{debug:a.debug,initToken:a.initToken,initTime:a.initTime,notifyUrl:a.notifyUrl}};if(t)return f&&_(f,e);(t=i.createElement("iframe")).src=a.ssoServer+a.ssoCheckUri,t.width=t.height=t.frameBorder=0,t.style.display="none",$(t,"load",function(){_(f=t.contentWindow,e)}),d.appendChild(t)},stopCheck:function(){_(f,{stopCheck:!0})},getUid:function(){return n.get("uid")},setUid:function(e,t){C("Set uid: "+e),n.set("uid",e,{TTL:t||0})}},!v||!S||!y)throw new Error("Please include `JSON`, `fetch` and `localStorage` polyfill scripts to your page.");$(r,"load",function(){c.init(r.$ssoOptions)})}(window,document);