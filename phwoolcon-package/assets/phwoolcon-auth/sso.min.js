!function(o,n){var i,r,s,t,c,a,l,u,d;o.$p||(o.$p={options:{ssoCheckUri:"sso/check",ssoServerCheckUri:"sso/server-check",baseUrl:"/"}});var p={ssoServer:$p.options.baseUrl,ssoCheckUri:$p.options.ssoCheckUri,ssoServerCheckUri:$p.options.ssoServerCheckUri,initToken:"",initTime:0,notifyUrl:"",debug:!1},f="_sso_client_iframe_"+ +new Date,h={},g=o.simpleStorage||{get:function(e){return!!o.localStorage&&y(o.localStorage.getItem("_sso_"+e))},set:function(e,t){return!!o.localStorage&&o.localStorage.setItem("_sso_"+e,v(t))}},m=o.$p.sso={options:p,init:function(e){if(m.setOptions(e),!i)if(i=!0,r=n.getElementsByTagName("body")[0],$p.options.isSsoServer)u=n.referrer,k(o,"message",function(e){(function(e){var t,n,i=y(e.data);(n=i.setOptions)&&m.setOptions(n);U("Handle in iframe"),(t=i.clientUid)&&(U("Aware client uid: "+t),h.clientUid=t);i.check&&function e(){var t=h.clientUid,n=m.getUid();c=o.parent;d=setTimeout(function(){e.apply(m)},1e3);if(t==n)return;U("Server uid: "+n);n?(U("Login: "+n),fetch(p.ssoServer+p.ssoServerCheckUri,{method:"POST",body:$p.jsonToFormData({notifyUrl:p.notifyUrl,initTime:p.initTime,initToken:p.initToken})}).then(function(e){if(200<=e.status&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,t}).then(function(e){return e.json()}).then(function(e){h.clientUid=n,U(e),S(c,{login:e.user_data})}).catch(function(e){U("Request failed:"),U(e)}),S(c,{setUid:n})):(t&&U("Logout"),h.clientUid=null,S(c,{logout:!0}))}.apply(m);i.stopCheck&&(U("Stop checking"),clearTimeout(d))}).apply(m,[e])});else{u=p.ssoServer,k(o,"message",function(e){(function(e){var t=y(e.data);U("Handle in client"),t.login&&function(e){U("Client login"),U(e),l.notifyField.value=e,l.submit(),U("App notification sent")}(t.login);t.setUid&&m.setUid(t.setUid);t.logout&&(h.clientUid&&U("Client logout"),m.setUid(null),l.notifyField.value="",l.submit(),U("App notification sent"))}).apply(m,[e])}),(s=n.createElement("iframe")).width=s.height=s.frameBorder=0,s.style.display="none",s.name=f,s.src="",r.appendChild(s);var t=n.createElement("input");t.type="hidden",t.name="sso_user_data",(l=n.createElement("form")).action=p.notifyUrl,l.style.display="none",l.method="POST",l.target=f,l.appendChild(t),l.notifyField=t,r.appendChild(l),m.check()}},setOptions:function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&(p[t]=e[t]);return m},check:function(){if(!i)throw new Error("Please invoke $p.sso.init() first.");U("Start checking");var e={clientUid:m.getUid(),check:!0,setOptions:{debug:p.debug,initToken:p.initToken,initTime:p.initTime,notifyUrl:p.notifyUrl}};if(t)return a&&S(a,e);(t=n.createElement("iframe")).src=p.ssoServer+p.ssoCheckUri,t.width=t.height=t.frameBorder=0,t.style.display="none",k(t,"load",function(){S(a=t.contentWindow,e)}),r.appendChild(t)},stopCheck:function(){S(a,{stopCheck:!0})},getUid:function(){return g&&g.get("uid")},setUid:function(e,t){U("Set uid: "+e),g&&g.set("uid",e,{TTL:t||0})}};function U(e){o.console&&p.debug&&(o.console.trace?o.console.trace(e):o.console.log(e))}function y(t){try{return o.JSON.parse(t)}catch(e){return t}}function v(e){return o.JSON.stringify(e)}function k(e,t,n){"addEventListener"in e?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)}function S(e,t){e.postMessage("string"==typeof t?t:v(t),u)}if(!o.JSON)throw new Error("Please include JSON support script to your page.");k(o,"load",function(){m.init(o.$ssoOptions)})}(window,document);