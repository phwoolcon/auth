!function(e,t){e.$p||(e.$p={options:{ssoCheckUri:"sso/check",ssoServerCheckUri:"sso/server-check",ssoServerGetUid:"sso/uid",baseUrl:"/"}});var i,n,o,r,s,c,a,d,l,u,f,p,g,h={},U=e.console,m=e.JSON,v=e.fetch,S=e.localStorage,y=$p.options.isSsoServer?"[Server]":"[Client]",k="_sso_client_iframe_"+ +new Date;function T(e){o.debug&&U&&(U.debug?U.debug(y,e):U.log(y,e))}function C(e){U&&(U.error?U.error(y,e):U.log(y,e))}function b(e){try{return m.parse(e)}catch(t){return e}}function w(e){return m.stringify(e)}function O(e,t,i){"addEventListener"in e?e.addEventListener(t,i,!1):e.attachEvent("on"+t,i)}function $(e,t){e.postMessage("string"==typeof t?t:w(t),p)}function _(){var t=h.clientUid,r=n.getUid();function s(e){if(e.status>=200&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,t}function c(e){return e.json()}function a(e){g=setTimeout(_,e)}if(l=e.parent,r===i)return T("Clarifying uid..."),void v(o.ssoServer+o.ssoServerGetUid,{credentials:"same-origin"}).then(s).then(c).then(function(e){T(e),n.setUid(e.uid,1e3*e.uidTtl),_()}).catch(function(e){T("Request failed:"),C(e),a(6e4)});a(1e3),t!==r&&(T("Server uid: "+r),r?(E(),T("Login: "+r),v(o.ssoServer+o.ssoServerCheckUri,{method:"POST",credentials:"same-origin",body:$p.jsonToFormData({notifyUrl:o.notifyUrl,initTime:o.initTime,initToken:o.initToken})}).then(s).then(c).then(function(e){var t=e.user_data;T(e),t?$(l,{login:t}):(n.setUid(r=null),$(l,{logout:!0})),h.clientUid=r,a(1e3)}).catch(function(e){T("Request failed:"),C(e),a(6e4)}),$(l,{setUid:r})):(t&&T("Logout"),h.clientUid=null,$(l,{logout:!0})))}function E(){clearTimeout(g)}if(o={ssoServer:$p.options.baseUrl,ssoCheckUri:$p.options.ssoCheckUri,ssoServerCheckUri:$p.options.ssoServerCheckUri,ssoServerGetUid:$p.options.ssoServerGetUid,initToken:"",initTime:0,loggedIn:null,notifyUrl:"",debug:!1},r=e.simpleStorage||{get:function(e){return b(S.getItem("_sso_"+e))},set:function(e,t){return S.setItem("_sso_"+e,w(t))}},n=e.$p.sso={options:o,init:function(r){if(n.setOptions(r),!s)if(s=!0,c=t.getElementsByTagName("body")[0],$p.options.isSsoServer)p=t.referrer,O(e,"message",function(e){(function(e){var t=b(e.data),i=t.clientUid,o=t.setOptions;o&&n.setOptions(o);T("Handle in iframe"),i&&(T("Aware client uid: "+i),h.clientUid=i);t.check&&_();t.stopCheck&&(T("Stop checking"),E())}).apply(n,[e])});else{(o.loggedIn&&!n.getUid()||!1===o.loggedIn&&n.getUid())&&n.setUid(i),p=o.ssoServer,O(e,"message",function(e){(function(e){var t=b(e.data);T("Handle in client"),t.login&&(i=t.login,T("Client login"),T(i),f.notifyField.value=i,f.submit(),T("App notification sent"));var i;t.setUid&&n.setUid(t.setUid);t.logout&&(h.clientUid&&T("Client logout"),n.setUid(null),f.notifyField.value="",f.submit(),T("App notification sent"))}).apply(n,[e])}),(a=t.createElement("iframe")).width=a.height=a.frameBorder=0,a.style.display="none",a.name=k,a.src="",c.appendChild(a);var d=t.createElement("input");d.type="hidden",d.name="sso_user_data",(f=t.createElement("form")).action=o.notifyUrl,f.style.display="none",f.method="POST",f.target=k,f.appendChild(d),f.notifyField=d,c.appendChild(f),n.check()}},setOptions:function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&(o[t]=e[t]);return n},check:function(){T("Start checking");var e={clientUid:n.getUid(),check:!0,setOptions:{debug:o.debug,initToken:o.initToken,initTime:o.initTime,notifyUrl:o.notifyUrl}};if(d)return u&&$(u,e);(d=t.createElement("iframe")).src=o.ssoServer+o.ssoCheckUri,d.width=d.height=d.frameBorder=0,d.style.display="none",O(d,"load",function(){$(u=d.contentWindow,e)}),c.appendChild(d)},stopCheck:function(){$(u,{stopCheck:!0})},getUid:function(){return r.get("uid")},setUid:function(e,t){T("Set uid: "+e),r.set("uid",e,{TTL:t||0})}},!m||!v||!S)throw new Error("Please include `JSON`, `fetch` and `localStorage` polyfill scripts to your page.");O(e,"load",function(){n.init(e.$ssoOptions)})}(window,document);