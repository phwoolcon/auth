!function(e,t){function n(e){r("Client login"),r(e),w.setUid(e.uid)}function i(){k.clientUid&&r("Client logout"),w.setUid(null)}function o(e){var t,o=s(e.data);r("Handle in client"),(t=o.login)&&n(t),o.logout&&i()}function r(t){e.console&&m.debug&&e.console.log(t)}function s(t){var n;try{return n=e.JSON.parse(t)}catch(i){return t}}function c(t){return e.JSON.stringify(t)}function u(e,t,n){"addEventListener"in e?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)}function a(e,t){e.postMessage("string"==typeof t?t:c(t),v)}function l(){var t,n=k.clientUid,i=w.getUid();g=e.parent,S=setTimeout(function(){l.apply(w)},1e3),n!=i&&(r("Server uid: "+i),i?(r("Login: "+i),t={uid:i},k.clientUid=i,a(g,{login:t})):(n&&r("Logout"),k.clientUid=null,a(g,{logout:!0})))}function d(e){var t,n=s(e.data);n.debug&&(m.debug=!0),r("Handle in iframe"),(t=n.clientUid)&&(r("Aware client uid: "+t),k.clientUid=t),n.check&&l.apply(w),n.stopCheck&&(r("Stop checking"),clearTimeout(S))}e.$p||(e.$p={options:{ssoCheckUri:"sso/check",baseUrl:"/"}});var p,f,g,h,v,S,U=(e.jQuery,$p.options.ssoCheckUri,86400),m={ssoServer:$p.options.baseUrl,siteId:0,ssoToken:"",initTime:0,debug:!1},k={},y=e.simpleStorage||{get:function(t){var n=e.localStorage?e.localStorage.getItem("_sso_"+t):!1;return"null"==n?null:n},set:function(t,n){return e.localStorage?e.localStorage.setItem("_sso_"+t,n):!1}},w=e.$p.sso={options:m,init:function(n){if(w.setOptions(n),!p){if(m.initTime&&new Date/1e3>m.initTime+U)return void e.location.reload();p=!0,$p.options.isSsoServer?(v=t.referrer,u(e,"message",function(e){d.apply(w,[e])})):(v=m.ssoServer,u(e,"message",function(e){o.apply(w,[e])}))}},setOptions:function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&(m[t]=e[t]);return w},check:function(){if(!p)throw new Error("Please invoke $p.sso.init() first.");r("Start checking");var e=w.getUid(),n={debug:m.debug,clientUid:e,check:!0};return f?h&&a(h,n):(f=t.createElement("iframe"),f.src=m.ssoServer+m.ssoCheckUri,f.width=f.height=f.frameBorder=0,f.style.display="none",u(f,"load",function(){h=f.contentWindow,a(h,n)}),void t.getElementsByTagName("body")[0].appendChild(f))},stopCheck:function(){a(h,{stopCheck:!0})},getUid:function(){return y&&y.get("uid")},setUid:function(e,t){r("Set uid: "+e),y&&y.set("uid",e,{TTL:t||0})}};if(!e.JSON)throw new Error("Please include JSON support script to your page.");u(e,"load",function(){w.init()})}(window,document);
